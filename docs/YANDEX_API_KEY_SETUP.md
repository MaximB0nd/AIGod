# Инструкция: API-ключ Yandex GPT и интеграция в AI Society Simulator

Полное руководство по регистрации в Yandex Cloud, созданию API-ключа для YandexGPT и его подключению к проекту.

---

## Содержание

1. [Регистрация в Yandex Cloud](#1-регистрация-в-yandex-cloud)
2. [Создание каталога и получение Folder ID](#2-создание-каталога-и-получение-folder-id)
3. [Создание API-ключа](#3-создание-api-ключа)
4. [Интеграция ключа в проект](#4-интеграция-ключа-в-проект)
5. [Проверка работы](#5-проверка-работы)
6. [Устранение неполадок](#6-устранение-неполадок)

---

## 1. Регистрация в Yandex Cloud

### Шаг 1.1. Вход в консоль

1. Перейдите на [console.yandex.cloud](https://console.yandex.cloud/)
2. Войдите через **Яндекс ID** (если нет аккаунта — зарегистрируйтесь на [yandex.ru](https://yandex.ru) или через Яндекс.Почту)

### Шаг 1.2. Активация платформы

1. При первом входе примите условия использования Yandex Cloud
2. Подключите способ оплаты (карта или счёт для юридических лиц)
3. Пополните баланс — **минимум 500 ₽** (требуется для активации платных сервисов, включая YandexGPT)

> **Тарификация YandexGPT:** ~0,6 ₽ за 1000 токенов. Лимит `API_MESSAGE_LIMIT_PER_DAY` в проекте защищает от перерасхода.

### Шаг 1.3. Создание облака (если нужно)

- По умолчанию создаётся облако и каталог `default`
- Если облака нет — нажмите **«Создать облако»** и следуйте подсказкам

---

## 2. Создание каталога и получение Folder ID

**Каталог (folder)** — контейнер для ресурсов. ID каталога нужен для работы с YandexGPT API.

### Вариант A: Использовать каталог по умолчанию

1. В верхней панели консоли найдите **селектор каталогов** (выпадающий список)
2. Выберите каталог `default` (или другой существующий)
3. **Folder ID** — это строка вида `b1gxxxxxxxxxxxxxxxxxx` (начинается с `b1g`)
4. Скопируйте ID: наведите на название каталога или откройте настройки каталога — ID отображается там

### Вариант B: Создать новый каталог

1. В левом меню: **Управление ресурсами** → **Каталоги**
2. Нажмите **«Создать каталог»**
3. Укажите имя (например, `aigod`) и нажмите **«Создать»**
4. Откройте созданный каталог — **Folder ID** указан на странице или в URL

> **Сохраните Folder ID** — он понадобится для переменной `YANDEX_CLOUD_FOLDER`.

---

## 3. Создание API-ключа

Есть два способа: через AI Studio (проще) и через сервисный аккаунт (для production).

### Способ 1: Через AI Studio (рекомендуется для начала)

1. В левом меню консоли выберите **AI Studio** (или перейдите в раздел **Генеративные модели**)
2. В верхней панели найдите кнопку **«Создать API-ключ»** / **«Create API key»**
3. В диалоге:
   - **Область (Scope):** выберите `yc.ai.languageModels.execute` или аналогичную роль для языковых моделей
   - При необходимости укажите описание
4. Нажмите **«Создать»**
5. **Важно:** ключ показывается **один раз**. Скопируйте и сохраните его в надёжном месте (например, в менеджере паролей)

> Ключ имеет формат длинной строки. В проекте используется как есть, без префикса `Api-Key` — код добавляет его при необходимости.

### Способ 2: Через сервисный аккаунт (для production)

1. В левом меню: **Управление ресурсами** → **Сервисные аккаунты**
2. Нажмите **«Создать сервисный аккаунт»**
3. Укажите имя (например, `aigod-llm`) и описание
4. Нажмите **«Добавить роль»** и выберите **`ai.languageModels.user`**
5. Создайте аккаунт
6. Откройте созданный сервисный аккаунт → вкладка **«API-ключи»**
7. Нажмите **«Создать API-ключ»** → **«Создать авторизованный ключ»**
8. Сохраните закрытый ключ (файл `.json`) — он понадобится для получения IAM-токена

> Для сервисного аккаунта можно использовать **IAM-токен** вместо статического API-ключа. Токен живёт до 12 часов. В проекте поддерживается переменная `YANDEX_IAM_TOKEN` (приоритетнее API-ключа).

---

## 4. Интеграция ключа в проект

### Шаг 4.1. Создание файла `.env`

В **корне проекта** (рядом с `docker-compose.yml`) создайте файл `.env`:

```bash
# Из корня проекта
cp python-backend/.env.example .env
```

### Шаг 4.2. Заполнение переменных

Откройте `.env` и укажите:

```env
# Yandex Cloud (обязательно для работы LLM)
YANDEX_CLOUD_FOLDER=b1gxxxxxxxxxxxxxxxxxx
YANDEX_CLOUD_API_KEY=ваш_api_ключ_из_шага_3

# Лимит вызовов API в день — защита от перерасхода
API_MESSAGE_LIMIT_PER_DAY=100

# Опционально: JWT-секрет для production
# SECRET_KEY=your-secret-key
```

**Замените:**
- `b1gxxxxxxxxxxxxxxxxxx` — ваш **Folder ID** из шага 2
- `ваш_api_ключ_из_шага_3` — **API-ключ** из шага 3 (без префикса `Api-Key`)

### Шаг 4.3. Безопасность

- **Не коммитьте `.env` в Git** — файл должен быть в `.gitignore`
- Не публикуйте ключ в открытых репозиториях и логах
- Для production используйте секреты (Docker secrets, Kubernetes secrets, переменные окружения CI/CD)

---

## 5. Проверка работы

### Запуск через Docker Compose

```bash
# Из корня проекта
docker-compose up --build
```

Бэкенд будет доступен на **http://localhost:8000**

### Проверка через Swagger

1. Откройте http://localhost:8000/docs
2. Авторизуйтесь (если требуется)
3. Вызовите любой эндпоинт, который обращается к LLM (например, отправка сообщения агенту)

### Запуск без Docker (локальная разработка)

```bash
cd python-backend
pip install -r requirements.txt
# .env должен быть в python-backend/ или в корне (load_dotenv поднимается выше)
uvicorn app.main:app --reload
```

---

## 6. Устранение неполадок

### «Агент временно недоступен»

- Проверьте, что `YANDEX_CLOUD_FOLDER` и `YANDEX_CLOUD_API_KEY` заданы в `.env`
- Убедитесь, что `.env` находится в корне проекта (для Docker) или в `python-backend/` (для локального запуска)

### Ошибка 401 / Unauthorized

- API-ключ неверный или отозван — создайте новый ключ
- У сервисного аккаунта должна быть роль `ai.languageModels.user`

### Ошибка 403 / Permission denied

- Проверьте, что каталог (Folder ID) существует и у ключа есть доступ к нему
- Убедитесь, что в каталоге включён сервис YandexGPT / AI Studio

### «Лимит обращений к AI исчерпан»

- Сработал `API_MESSAGE_LIMIT_PER_DAY` — защита от перерасхода
- Увеличьте лимит в `.env` или дождитесь следующего дня

### Альтернатива: IAM-токен

Если используете сервисный аккаунт с JSON-ключом:

```bash
yc iam create-token
```

Добавьте в `.env`:

```env
YANDEX_IAM_TOKEN=t1.9eu...
```

Токен действует до 12 часов — для production лучше автоматизировать его обновление.

---

## Ссылки

- [Yandex Cloud Console](https://console.yandex.cloud/)
- [Документация Yandex AI Studio](https://yandex.cloud/ru/docs/ai-studio/)
- [Yandex AI Studio SDK (PyPI)](https://pypi.org/project/yandex-ai-studio-sdk/)

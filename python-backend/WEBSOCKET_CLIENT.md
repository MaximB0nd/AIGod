# WebSocket ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (v1.0.0)

–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ä–µ–∞–ª—å–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ –∫–æ–º–Ω–∞—Ç—ã: —á–∞—Ç (—Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Å–æ–±—ã—Ç–∏—è) –∏ –≥—Ä–∞—Ñ –æ—Ç–Ω–æ—à–µ–Ω–∏–π.

**–°–º. —Ç–∞–∫–∂–µ:**
- `API_DOCS.md` ‚Äî –ø–æ–ª–Ω—ã–π REST-—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫
- `CONNECTION.md` ‚Äî –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

---

## –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

| –†–µ–∂–∏–º        | WebSocket URL               | REST API        |
|--------------|-----------------------------|------------------|
| –õ–æ–∫–∞–ª—å–Ω–æ     | `ws://localhost:8000`        | `http://localhost:8000` |
| Production   | `wss://your-domain.com`     | `https://your-domain.com` |

–¢–æ–∫–µ–Ω –ø–æ–ª—É—á–∞—é—Ç –∏–∑ `POST /api/auth/login` (–ø–æ–ª–µ `token`).

---

## 1. –ß–∞—Ç –∫–æ–º–Ω–∞—Ç—ã

**Endpoint:** `WS /api/rooms/{roomId}/chat`

–ü–æ—Ç–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π (–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∞–≥–µ–Ω—Ç–æ–≤, —Å–∏—Å—Ç–µ–º—ã) –∏ —Å–æ–±—ã—Ç–∏–π –≤ –∫–æ–º–Ω–∞—Ç–µ.

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

```
ws://localhost:8000/api/rooms/1/chat?token=YOUR_JWT_TOKEN
```

- `roomId` ‚Äî ID –∫–æ–º–Ω–∞—Ç—ã (–∏–∑ `GET /api/rooms`)
- `token` ‚Äî JWT –∏–∑ `POST /api/auth/login` (–ø–æ–ª–µ `token` –≤ –æ—Ç–≤–µ—Ç–µ)

### –ö–æ–¥—ã –∑–∞–∫—Ä—ã—Ç–∏—è

| –ö–æ–¥  | –ó–Ω–∞—á–µ–Ω–∏–µ                                |
|------|-----------------------------------------|
| 4001 | –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω (–Ω–µ—Ç –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π token) |
| 4003 | –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–º–Ω–∞—Ç–µ                   |

### –í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞

–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON: `{ "type": string, "payload": object }`.

#### `connected` ‚Äî —É—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

```json
{
  "type": "connected",
  "payload": {
    "roomId": "1",
    "message": "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —á–∞—Ç—É –∫–æ–º–Ω–∞—Ç—ã"
  }
}
```

#### `message` ‚Äî –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ

```json
{
  "type": "message",
  "payload": {
    "id": "42",
    "text": "–ü—Ä–∏–≤–µ—Ç! –í—ã–ø–æ–ª–Ω–∏ –∑–∞–¥–∞–Ω–∏–µ.",
    "sender": "user",
    "agentId": "3",
    "timestamp": "2025-02-16T14:30:00",
    "agentResponse": null
  }
}
```

| –ü–æ–ª–µ          | –¢–∏–ø    | –û–ø–∏—Å–∞–Ω–∏–µ                                  |
|---------------|--------|-------------------------------------------|
| id            | string | ID —Å–æ–æ–±—â–µ–Ω–∏—è                              |
| text          | string | –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è                           |
| sender        | string | –ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è: `"user"`, –∏–º—è –∞–≥–µ–Ω—Ç–∞, `"üé≠ –†–∞—Å—Å–∫–∞–∑—á–∏–∫ –ù–∞—Ä—Ä–∞—Ç–æ—Ä"`, `"üìä –°–≤–æ–¥–∫–∞ –°—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä"`, `"–°–∏—Å—Ç–µ–º–∞"` |
| agentId       | string?| ID –∞–≥–µ–Ω—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å). `null` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –†–∞—Å—Å–∫–∞–∑—á–∏–∫, –°—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä, –°–∏—Å—Ç–µ–º–∞ |
| timestamp     | string | ISO 8601                                  |
| agentResponse | string?| –û—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞ (–µ—Å–ª–∏ —É–∂–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω). –í –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ |

–í —Ä–µ–∂–∏–º–µ `circular`: `sender` –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–º–µ–Ω–µ–º –∞–≥–µ–Ω—Ç–∞, `"üé≠ –†–∞—Å—Å–∫–∞–∑—á–∏–∫ –ù–∞—Ä—Ä–∞—Ç–æ—Ä"` (–Ω–∞—Ä—Ä–∞—Ç–∏–≤), `"üìä –°–≤–æ–¥–∫–∞ –°—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä"` (—Å–≤–æ–¥–∫–∞ —Ä–∞—É–Ω–¥–∞), `"–°–∏—Å—Ç–µ–º–∞"` (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–ª–∏ ¬´–†–∞—É–Ω–¥ X –∑–∞–≤–µ—Ä—à—ë–Ω¬ª).

#### `event` ‚Äî —Å–æ–±—ã—Ç–∏–µ –≤ –∫–æ–º–Ω–∞—Ç–µ

```json
{
  "type": "event",
  "payload": {
    "id": "7",
    "eventType": "user_event",
    "agentIds": ["1", "2"],
    "description": "–ê–ª–∏—Å–∞ –∏ –ë–æ–± –ø–æ—Å–ø–æ—Ä–∏–ª–∏",
    "timestamp": "2025-02-16T14:31:00"
  }
}
```

| –ü–æ–ª–µ        | –¢–∏–ø     | –û–ø–∏—Å–∞–Ω–∏–µ                    |
|-------------|---------|-----------------------------|
| id          | string  | ID —Å–æ–±—ã—Ç–∏—è                  |
| eventType   | string  | –¢–∏–ø —Å–æ–±—ã—Ç–∏—è                 |
| agentIds    | string[]| ID –∞–≥–µ–Ω—Ç–æ–≤, —É—á–∞—Å—Ç–≤—É—é—â–∏—Ö     |
| description | string  | –û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è            |
| timestamp   | string  | ISO 8601                    |

#### `pong` ‚Äî –æ—Ç–≤–µ—Ç –Ω–∞ ping

```json
{
  "type": "pong",
  "payload": {}
}
```

#### `error` ‚Äî –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

```json
{
  "type": "error",
  "payload": {
    "message": "–û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏"
  }
}
```

### –ò—Å—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–∫–ª–∏–µ–Ω—Ç ‚Üí —Å–µ—Ä–≤–µ—Ä)

–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –Ω—É–∂–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ ‚Äî **ping** –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:

```json
{"type": "ping"}
```

–í –æ—Ç–≤–µ—Ç –ø—Ä–∏–¥—ë—Ç `{"type": "pong", "payload": {}}`.

–û—Ç–ø—Ä–∞–≤–ª—è–π ping —Ä–∞–∑ –≤ 20‚Äì30 —Å–µ–∫—É–Ω–¥.

---

## 2. –ì—Ä–∞—Ñ –æ—Ç–Ω–æ—à–µ–Ω–∏–π

**Endpoint:** `WS /api/rooms/{roomId}/graph`

–ü–æ—Ç–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Ä—ë–±–µ—Ä –≥—Ä–∞—Ñ–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏–π –º–µ–∂–¥—É –∞–≥–µ–Ω—Ç–∞–º–∏.

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

```
ws://localhost:8000/api/rooms/1/graph?token=YOUR_JWT_TOKEN
```

### –í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è

#### `connected`

```json
{
  "type": "connected",
  "payload": {
    "roomId": "1",
    "message": "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –≥—Ä–∞—Ñ—É –æ—Ç–Ω–æ—à–µ–Ω–∏–π"
  }
}
```

#### `edge_update` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–±—Ä–∞

–ü—Ä–∏—Ö–æ–¥–∏—Ç –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è –∞–≥–µ–Ω—Ç–∞–º–∏ (–≤ —Ç.—á. —á–µ—Ä–µ–∑ `PATCH /api/rooms/{roomId}/relationships`).

```json
{
  "type": "edge_update",
  "payload": {
    "roomId": "1",
    "from": "1",
    "to": "2",
    "sympathyLevel": 0.7
  }
}
```

| –ü–æ–ª–µ          | –¢–∏–ø    | –û–ø–∏—Å–∞–Ω–∏–µ                              |
|---------------|--------|---------------------------------------|
| roomId        | string | ID –∫–æ–º–Ω–∞—Ç—ã                            |
| from          | string | ID –∞–≥–µ–Ω—Ç–∞ 1 (–∏—Å—Ç–æ–∫ —Ä–µ–±—Ä–∞)            |
| to            | string | ID –∞–≥–µ–Ω—Ç–∞ 2 (–∫–æ–Ω–µ—Ü —Ä–µ–±—Ä–∞)            |
| sympathyLevel | number | –£—Ä–æ–≤–µ–Ω—å —Å–∏–º–ø–∞—Ç–∏–∏ –æ—Ç -1 –¥–æ 1           |

–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∞ (D3.js, vis-network –∏ —Ç.–ø.) –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—Ä–æ—Å–∞ –≤—Å–µ–≥–æ –≥—Ä–∞—Ñ–∞.

#### `pong`, `error` ‚Äî —Ç–∞–∫–∏–µ –∂–µ, –∫–∞–∫ –≤ —á–∞—Ç–µ

---

## –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞

### JavaScript (–Ω–∞—Ç–∏–≤–Ω—ã–π WebSocket)

```javascript
const API_URL = 'http://localhost:8000';
const WS_URL = 'ws://localhost:8000';

// 1. –õ–æ–≥–∏–Ω, –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
const loginRes = await fetch(`${API_URL}/api/auth/login`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ email: 'user@example.com', password: 'password123' }),
});
const { token } = await loginRes.json();

// 2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —á–∞—Ç—É –∫–æ–º–Ω–∞—Ç—ã
const roomId = 1;
const chatWs = new WebSocket(`${WS_URL}/api/rooms/${roomId}/chat?token=${token}`);

chatWs.onopen = () => {
  console.log('Chat WebSocket connected');
};

chatWs.onmessage = (event) => {
  const msg = JSON.parse(event.data);
  switch (msg.type) {
    case 'connected':
      console.log('Room:', msg.payload.roomId);
      break;
    case 'message':
      addMessageToUI(msg.payload);
      break;
    case 'event':
      addEventToUI(msg.payload);
      break;
    case 'pong':
      // keepalive OK
      break;
    case 'error':
      console.error('WS error:', msg.payload.message);
      break;
  }
};

chatWs.onclose = (event) => {
  if (event.code === 4001) console.error('Unauthorized');
  if (event.code === 4003) console.error('No access to room');
};

// Ping –∫–∞–∂–¥—ã–µ 25 —Å–µ–∫
const pingInterval = setInterval(() => {
  if (chatWs.readyState === WebSocket.OPEN) {
    chatWs.send(JSON.stringify({ type: 'ping' }));
  }
}, 25000);

chatWs.onclose = () => clearInterval(pingInterval);
```

### –ì—Ä–∞—Ñ (React-–ø–æ–¥–æ–±–Ω—ã–π –ø—Ä–∏–º–µ—Ä)

```javascript
const graphWs = new WebSocket(`${WS_URL}/api/rooms/${roomId}/graph?token=${token}`);

graphWs.onmessage = (event) => {
  const msg = JSON.parse(event.data);
  if (msg.type === 'edge_update') {
    const { from, to, sympathyLevel } = msg.payload;
    // –û–±–Ω–æ–≤–∏—Ç—å —Ä–µ–±—Ä–æ –≤ D3/vis-network
    updateGraphEdge(from, to, sympathyLevel);
  }
};
```

### TypeScript —Ç–∏–ø—ã

```typescript
type ChatMessage = {
  type: 'connected' | 'message' | 'event' | 'pong' | 'error';
  payload: {
    roomId?: string;
    message?: string;
    id?: string;
    text?: string;
    sender?: 'user' | 'agent' | 'system';
    agentId?: string | null;
    timestamp?: string;
    agentResponse?: string | null;
    eventType?: string;
    agentIds?: string[];
    description?: string;
  };
};

type GraphMessage = {
  type: 'connected' | 'edge_update' | 'pong' | 'error';
  payload: {
    roomId?: string;
    message?: string;
    from?: string;
    to?: string;
    sympathyLevel?: number;
  };
};
```

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ü–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞** ‚Äî WebSocket –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–¥–∫–ª—é—á—ë–Ω –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ. –ò–Ω–∞—á–µ broadcast –Ω–µ –¥–æ–π–¥—ë—Ç –¥–æ –∫–ª–∏–µ–Ω—Ç–∞.
2. **–ó–∞–≥—Ä—É–∂–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é** ‚Äî –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞ –≤—ã–∑–æ–≤–∏ `GET /api/rooms/{roomId}/messages` –∏–ª–∏ `GET /api/rooms/{roomId}/feed`, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è.
3. **–°–º–µ–Ω–∞ –∫–æ–º–Ω–∞—Ç—ã** ‚Äî –∑–∞–∫—Ä–æ–π —Ç–µ–∫—É—â–∏–µ WS –∏ –ø–æ–¥–∫–ª—é—á–∏—Å—å –∫ –Ω–æ–≤—ã–º URL —Å –Ω–æ–≤—ã–º `roomId`.
4. **–°–º–µ–Ω–∞ —Ç–æ–∫–µ–Ω–∞** ‚Äî –ø–æ—Å–ª–µ refresh —Ç–æ–∫–µ–Ω–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–π WebSocket —Å –Ω–æ–≤—ã–º `token`.
5. **Reconnect** ‚Äî –ø—Ä–∏ `onclose` –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å `setTimeout` –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (–±–µ–∑ —Å–ø–∞–º–∞).
6. **Ping** ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–π `{"type": "ping"}` —Ä–∞–∑ –≤ 20‚Äì30 —Å–µ–∫, —á—Ç–æ–±—ã —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —Ä–≤–∞–ª–æ—Å—å.
7. **HTTPS** ‚Äî –≤ production –∏—Å–ø–æ–ª—å–∑—É–π `wss://` –Ω–∞ —Ç–æ–º –∂–µ —Ö–æ—Å—Ç–µ, —á—Ç–æ –∏ `https://`.

---

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫: —á–∞—Ç –ø—É—Å—Ç–æ–π

–ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î, –Ω–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ:

1. **WebSocket –ø–æ–¥–∫–ª—é—á—ë–Ω?** ‚Äî –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü—Ä–æ–≤–µ—Ä—å `onopen` –∏ `readyState === WebSocket.OPEN`.
2. **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π roomId?** ‚Äî URL `ws://.../api/rooms/{roomId}/chat` –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∫–æ–º–Ω–∞—Ç–æ–π, –∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å —Å–æ–æ–±—â–µ–Ω–∏—è.
3. **–õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞** ‚Äî –ø—Ä–∏ broadcast —Å 0 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –≤ –ª–æ–≥–µ –±—É–¥–µ—Ç: `broadcast room_id=X ‚Äî 0 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π, —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ`. –ó–Ω–∞—á–∏—Ç –∫–ª–∏–µ–Ω—Ç –Ω–µ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ WS —ç—Ç–æ–π –∫–æ–º–Ω–∞—Ç—ã.
4. **–ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** ‚Äî –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞ –≤—ã–∑–æ–≤–∏ `GET /api/rooms/{roomId}/messages` –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.

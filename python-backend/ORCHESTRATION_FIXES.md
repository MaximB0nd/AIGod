# Исправления оркестрации (v2)

Документация изменений в оркестрации агентов для клиентов и разработчиков.

---

## 1. Что исправлено

### 1.1 Агенты игнорировали пользователя и зацикливались

**Проблема:** После первого ответа агенты продолжали общаться друг с другом, теряя фокус на запросе пользователя.

**Исправление:**
- Запрос пользователя (`current_user_message`) сохраняется в `ConversationContext` и передаётся в каждый промпт агента.
- В промптах явно выделен блок **«ЗАПРОС ПОЛЬЗОВАТЕЛЯ (ГЛАВНЫЙ ФОКУС — НЕ ИГНОРИРУЙ)»**.
- Добавлена защита от бесконечного цикла: стратегия Circular останавливается после **5 раундов** (по умолчанию).

### 1.2 Память комнаты (ChromaDB) не использовалась

**Проблема:** Память комнаты создавалась с `vector_store=None`, ChromaDB не подключался.

**Исправление:**
- При наличии ChromaDB (`CHROMA_PERSIST_DIR` в env) используется векторное хранилище для каждой комнаты.
- Коллекции: `room_memory_{room_id}` в каталоге `./chroma_db` (или из env).
- Перед вызовом агента промпт обогащается релевантными воспоминаниями.
- После ответа агента пары (запрос пользователя + ответ) сохраняются в память.

### 1.3 Граф отношений не обновлялся

**Проблема:** `RelationshipManager` создавался с `analyzer=None`, граф отношений не менялся после диалогов.

**Исправление:**
- Добавлен `HeuristicRelationshipAnalyzer` (без LLM): по ключевым словам («согласен», «не согласен», «поддерживаю» и т.п.) обновляет связи между агентами.
- При каждом сообщении агента вызывается `process_message`, граф обновляется.

### 1.4 Стратегии вели себя одинаково

**Проблема:** Стратегии Circular, Narrator, FullContext могли казаться похожими.

**Уточнение:**
- **Circular** — агенты по кругу, запрос пользователя в центре, до 5 раундов.
- **Narrator** — один агент-рассказчик управляет повествованием, остальные — персонажи.
- **FullContext** — обсуждение с суммаризацией раундов.

Стратегия выбирается по `room.orchestration_type` при создании клиента.

---

## 2. Изменения для клиента

### 2.1 Поведение без изменений в API

- Эндпоинты и форматы ответов **не изменились**.
- WebSocket-события и формат сообщений остались прежними.
- Для клиента всё работает как раньше, но агенты ведут себя корректнее.

### 2.2 Что можно настроить

| Параметр | Где | Описание |
|----------|-----|----------|
| `orchestration_type` | Создание комнаты | `"single"`, `"circular"`, `"narrator"`, `"full_context"` |
| `CHROMA_PERSIST_DIR` | env | Путь к ChromaDB (по умолчанию `./chroma_db`) |
| `max_rounds` | Код стратегии Circular | Число раундов до остановки (по умолчанию 5) |

---

## 3. Логи для отладки

### 3.1 Оркестрация

| Лог | Значение |
|-----|----------|
| `orchestration get_or_start room_id=X создаём клиент type=circular` | Создан клиент оркестрации для комнаты |
| `orchestration_client enqueue_user_message room_id=X text_len=Y queue_size=Z` | Сообщение пользователя поставлено в очередь |
| `orchestration_client tick room_id=X tick=Y produced N messages` | Один тик сгенерировал N сообщений агентов |
| `orchestration on_message room_id=X type=agent sender=Y agent_id=Z` | Сообщение агента сохранено и отправлено в broadcast |

### 3.2 Память

| Лог | Значение |
|-----|----------|
| `orchestration memory stored room_id=X` | Диалог сохранён в память комнаты |
| `memory enhance failed: ...` | Не удалось обогатить промпт памятью |

### 3.3 Граф отношений

| Лог | Значение |
|-----|----------|
| `orchestration graph updated room_id=X sender=Y` | Граф отношений обновлён по сообщению агента |
| `orchestration graph update failed: ...` | Ошибка обновления графа |

### 3.4 Стратегия

| Лог | Значение |
|-----|----------|
| `create_orchestration_client room_id=X type=Y strategy=CircularStrategy` | Выбрана стратегия для комнаты |
| `orchestration_client stop room_id=X` | Оркестрация остановлена (достигнут max_rounds или stop) |

---

## 4. Порядок pipeline (внутренний)

1. **User message** → `enqueue_user_message` → очередь
2. **handle_user_message** → сохранить запрос в `context.current_user_message`
3. **Перед вызовом агента** → загрузка памяти (`get_relevant_context_async`), обогащение промпта
4. **Агент отвечает** → сохранение в БД, broadcast, обновление графа, сохранение в память
5. **После max_rounds** → остановка оркестрации

---

## 5. Требования

- **ChromaDB** для долгосрочной памяти: `pip install chromadb`
- **sentence-transformers** для эмбеддингов (ChromaDB их подтягивает при необходимости)

При отсутствии ChromaDB память работает в short-term режиме (без векторного поиска).

# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –∫ AIgod API

–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –∏ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞. –°–ª–µ–¥—É–π—Ç–µ —à–∞–≥–∞–º –ø–æ –ø–æ—Ä—è–¥–∫—É ‚Äî –≤—Å—ë –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.

---

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](#1-–±—ã—Å—Ç—Ä—ã–π-—Å—Ç–∞—Ä—Ç)
2. [–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞](#2-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è-–∏-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-—Å–µ—Ä–≤–µ—Ä–∞)
3. [–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è](#3-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)
4. [–ö–æ–º–Ω–∞—Ç—ã –∏ –∞–≥–µ–Ω—Ç—ã](#4-–∫–æ–º–Ω–∞—Ç—ã-–∏-–∞–≥–µ–Ω—Ç—ã)
5. [–°–æ–æ–±—â–µ–Ω–∏—è –∏ —á–∞—Ç](#5-—Å–æ–æ–±—â–µ–Ω–∏—è-–∏-—á–∞—Ç)
6. [WebSocket ‚Äî real-time](#6-websocket--real-time)
7. [–ì—Ä–∞—Ñ –æ—Ç–Ω–æ—à–µ–Ω–∏–π](#7-–≥—Ä–∞—Ñ-–æ—Ç–Ω–æ—à–µ–Ω–∏–π)
8. [–†–µ–∂–∏–º—ã –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏](#8-—Ä–µ–∂–∏–º—ã-–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏)
9. [–ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏](#9-–ø—Ä–∏–º–µ—Ä-–ø–æ–ª–Ω–æ–π-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
10. [–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫](#10-—É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ-–Ω–µ–ø–æ–ª–∞–¥–æ–∫)

---

## 1. –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ß–µ–∫-–ª–∏—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

- [ ] –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω (`uvicorn app.main:app`)
- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `YANDEX_CLOUD_FOLDER` –∏ `YANDEX_CLOUD_API_KEY` –∑–∞–¥–∞–Ω—ã –≤ `.env`
- [ ] –ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ `http://localhost:8000` (–∏–ª–∏ –≤–∞—à URL)
- [ ] **WebSocket –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –î–û –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π** ‚Äî –∏–Ω–∞—á–µ –æ—Ç–≤–µ—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤ –Ω–µ –ø—Ä–∏–¥—É—Ç
- [ ] –í—Å–µ –∑–∞—â–∏—â—ë–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å–æ–¥–µ—Ä–∂–∞—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Authorization: Bearer <token>`

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π flow

```
1. POST /api/auth/login        ‚Üí —Ç–æ–∫–µ–Ω
2. ws://host/api/rooms/{id}/chat?token=...  ‚Üí –ø–æ–¥–∫–ª—é—á–∏—Ç—å
3. POST /api/rooms/{id}/messages           ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
4. –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç—ã –ø–æ WebSocket (type: "message")
```

---

## 2. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

### URL

| –†–µ–∂–∏–º | REST API | WebSocket |
|-------|----------|-----------|
| –õ–æ–∫–∞–ª—å–Ω–æ | `http://localhost:8000` | `ws://localhost:8000` |
| Production | `https://your-domain.com` | `wss://your-domain.com` |

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API

- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Å–µ—Ä–≤–µ—Ä)

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|-------------|----------|
| `YANDEX_CLOUD_FOLDER` | –î–∞* | ID –ø–∞–ø–∫–∏ –≤ Yandex Cloud |
| `YANDEX_CLOUD_API_KEY` | –î–∞* | API-–∫–ª—é—á Yandex GPT |
| `SECRET_KEY` | –ù–µ—Ç | JWT secret (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å—Ç—å) |
| `SQLITE_DB_PATH` | –ù–µ—Ç | –ü—É—Ç—å –∫ –ë–î (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `agents.db`) |
| `CHROMA_PERSIST_DIR` | –ù–µ—Ç | –ü—É—Ç—å –∫ ChromaDB –¥–ª—è –ø–∞–º—è—Ç–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `./chroma_db`) |

\* –ë–µ–∑ Yandex –∫–ª—é—á–µ–π –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è ‚Äî —Å—Ä–∞–±–æ—Ç–∞–µ—Ç fallback –≤ —Ä–µ–∂–∏–º single.

### –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞

```bash
cd python-backend
pip install -r requirements.txt
# –°–æ–∑–¥–∞—Ç—å .env —Å YANDEX_CLOUD_FOLDER –∏ YANDEX_CLOUD_API_KEY
uvicorn app.main:app --reload --host 0.0.0.0
```

---

## 3. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

```http
POST /api/auth/register
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password123",
  "username": "user"
}
```

–û—Ç–≤–µ—Ç:

```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "id": "1",
  "email": "user@example.com",
  "username": "user"
}
```

### –õ–æ–≥–∏–Ω

```http
POST /api/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password123"
}
```

–û—Ç–≤–µ—Ç: —Ç–æ—Ç –∂–µ —Ñ–æ—Ä–º–∞—Ç —Å `token`.

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞

–î–æ–±–∞–≤–∏—Ç—å –∫–æ **–≤—Å–µ–º** –∑–∞—â–∏—â—ë–Ω–Ω—ã–º –∑–∞–ø—Ä–æ—Å–∞–º:

```
Authorization: Bearer <token>
```

–¢–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω `ACCESS_TOKEN_EXPIRE_MINUTES` –º–∏–Ω—É—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30).

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏

```http
GET /api/auth/me
Authorization: Bearer <token>
```

---

## 4. –ö–æ–º–Ω–∞—Ç—ã –∏ –∞–≥–µ–Ω—Ç—ã

### –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã

```http
POST /api/rooms
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "–û–±—Å—É–∂–¥–µ–Ω–∏–µ —Å—Ç–∞—Ä—Ç–∞–ø–∞",
  "description": "–ò–¥–µ–∏ –∏ –ø–ª–∞–Ω—ã",
  "orchestration_type": "circular"
}
```

–û—Ç–≤–µ—Ç:

```json
{
  "id": "1",
  "name": "–û–±—Å—É–∂–¥–µ–Ω–∏–µ —Å—Ç–∞—Ä—Ç–∞–ø–∞",
  "description": "–ò–¥–µ–∏ –∏ –ø–ª–∞–Ω—ã",
  "speed": 1.0,
  "orchestration_type": "circular",
  "createdAt": "2025-02-18T12:00:00",
  "updatedAt": null,
  "agentCount": null
}
```

**orchestration_type:**

- `single` ‚Äî –∫–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- `circular` ‚Äî –∞–≥–µ–Ω—Ç—ã –æ–±—â–∞—é—Ç—Å—è –ø–æ –∫—Ä—É–≥—É, –¥–æ 50 —Ä–∞—É–Ω–¥–æ–≤. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—á–∞—Å—Ç–≤—É—é—Ç –†–∞—Å—Å–∫–∞–∑—á–∏–∫ (üé≠) –∏ –°—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä (üìä)
- `narrator` ‚Äî –æ–¥–∏–Ω —Ä–∞—Å—Å–∫–∞–∑—á–∏–∫ –≤–µ–¥—ë—Ç –∏—Å—Ç–æ—Ä–∏—é
- `full_context` ‚Äî –æ–±—Å—É–∂–¥–µ–Ω–∏–µ —Å —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–µ–π

### –°–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç

```http
GET /api/rooms
Authorization: Bearer <token>
```

–û—Ç–≤–µ—Ç: `{ "rooms": [ ... ] }`

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞

**–ò–∑ —à–∞–±–ª–æ–Ω–∞:**

```http
GET /api/default-agents
GET /api/default-agents/1
```

**–°–æ–∑–¥–∞–Ω–∏–µ –≤ –∫–æ–º–Ω–∞—Ç–µ:**

```http
POST /api/rooms/{roomId}/agents
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "–ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥",
  "character": "–≠–∫—Å–ø–µ—Ä—Ç –ø–æ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—é. –õ—é–±–∏—Ç –¥–∞–Ω–Ω—ã–µ –∏ A/B —Ç–µ—Å—Ç—ã.",
  "avatar": "https://..."
}
```

–û—Ç–≤–µ—Ç: `{ "id": "1", "name": "–ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥", "avatar": "..." }`

### –°–ø–∏—Å–æ–∫ –∞–≥–µ–Ω—Ç–æ–≤ –∫–æ–º–Ω–∞—Ç—ã

```http
GET /api/rooms/{roomId}/agents
Authorization: Bearer <token>
```

---

## 5. –°–æ–æ–±—â–µ–Ω–∏—è –∏ —á–∞—Ç

### –°–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–±—â–∏–π —á–∞—Ç (–≤—Å–µ –∞–≥–µ–Ω—Ç—ã)

```http
POST /api/rooms/{roomId}/messages
Authorization: Bearer <token>
Content-Type: application/json

{
  "text": "–ö–∞–∫ –ª—É—á—à–µ –ø—Ä–æ–≤–µ—Å—Ç–∏ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—É—é –∫–∞–º–ø–∞–Ω–∏—é?",
  "sender": "user"
}
```

–û—Ç–≤–µ—Ç (—Å—Ä–∞–∑—É):

```json
{
  "id": "123",
  "text": "–ö–∞–∫ –ª—É—á—à–µ –ø—Ä–æ–≤–µ—Å—Ç–∏ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—É—é –∫–∞–º–ø–∞–Ω–∏—é?",
  "sender": "user",
  "timestamp": "2025-02-18T12:00:00",
  "agentId": null,
  "agentResponse": null
}
```

**–û—Ç–≤–µ—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤ –ø—Ä–∏—Ö–æ–¥—è—Ç –ø–æ WebSocket** (—Å–º. —Ä–∞–∑–¥–µ–ª 6). –í —Ä–µ–∂–∏–º–µ `circular`/`narrator`/`full_context` —Å–Ω–∞—á–∞–ª–∞ –∏–¥—ë—Ç –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤, –∑–∞—Ç–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç ¬´–°–∏—Å—Ç–µ–º—ã¬ª.

### –°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∞–≥–µ–Ω—Ç—É

```http
POST /api/rooms/{roomId}/agents/{agentId}/messages
Authorization: Bearer <token>
Content-Type: application/json

{
  "text": "–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ",
  "sender": "user"
}
```

–û—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç `agentResponse` —Å —Ç–µ–∫—Å—Ç–æ–º –æ—Ç–≤–µ—Ç–∞ –∞–≥–µ–Ω—Ç–∞.

### –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

```http
GET /api/rooms/{roomId}/messages?limit=20
GET /api/rooms/{roomId}/messages?after_id=100&limit=20
Authorization: Bearer <token>
```

–û—Ç–≤–µ—Ç:

```json
{
  "messages": [
    {
      "id": "1",
      "text": "–¢–µ–∫—Å—Ç",
      "sender": "user",
      "agentId": null,
      "timestamp": "2025-02-18T12:00:00"
    }
  ],
  "hasMore": false
}
```

### –õ–µ–Ω—Ç–∞ (—Å–æ–æ–±—â–µ–Ω–∏—è + —Å–æ–±—ã—Ç–∏—è)

```http
GET /api/rooms/{roomId}/feed
Authorization: Bearer <token>
```

---

## 6. WebSocket ‚Äî real-time

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —á–∞—Ç—É

**URL:**

```
ws://localhost:8000/api/rooms/{roomId}/chat?token={JWT}
```

–ó–∞–º–µ–Ω–∏—Ç–µ `localhost:8000` –Ω–∞ –≤–∞—à —Ö–æ—Å—Ç. –í production: `wss://`.

**–í–∞–∂–Ω–æ:** –ø–æ–¥–∫–ª—é—á–∏—Ç–µ WebSocket **–¥–æ** –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π. –ò–Ω–∞—á–µ broadcast –Ω–µ –¥–æ–π–¥—ë—Ç.

### –í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è

–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–º–µ—é—Ç –≤–∏–¥:

```json
{
  "type": "connected" | "message" | "event" | "pong" | "error",
  "payload": { ... }
}
```

| type | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| connected | –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ |
| message | –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–≤ —Ç.—á. –æ—Ç –∞–≥–µ–Ω—Ç–æ–≤) |
| event | –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ |
| pong | –û—Ç–≤–µ—Ç –Ω–∞ ping |
| error | –û—à–∏–±–∫–∞ |

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ `payload` –¥–ª—è `message`:**

```json
{
  "id": "124",
  "text": "–ü—Ä–µ–¥–ª–∞–≥–∞—é –Ω–∞—á–∞—Ç—å —Å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –¶–ê...",
  "sender": "–ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥",
  "agentId": "1",
  "timestamp": "2025-02-18T12:00:05"
}
```

- `agentId: null` ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–µ  
- `sender: "–ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥"` ‚Äî –∞–≥–µ–Ω—Ç –∫–æ–º–Ω–∞—Ç—ã  
- `sender: "üé≠ –†–∞—Å—Å–∫–∞–∑—á–∏–∫ –ù–∞—Ä—Ä–∞—Ç–æ—Ä"` ‚Äî –Ω–∞—Ä—Ä–∞—Ç–∏–≤–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç, –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã (—Ä–µ–∂–∏–º `circular`)  
- `sender: "üìä –°–≤–æ–¥–∫–∞ –°—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä"` ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–≤–æ–¥–∫–∞ —Ä–∞—É–Ω–¥–∞ (—Ä–µ–∂–∏–º `circular`)  
- `sender: "–°–∏—Å—Ç–µ–º–∞"` ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å–∏–Ω—Ç–µ–∑ –∏–ª–∏ ¬´=== –†–∞—É–Ω–¥ X –∑–∞–≤–µ—Ä—à—ë–Ω ===¬ª (—Ä–µ–∂–∏–º `circular`)

### Ping/Pong

–ö–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å ping —Ä–∞–∑ –≤ 20‚Äì30 —Å–µ–∫—É–Ω–¥:

```json
{"type": "ping"}
```

–°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç `{"type": "pong", "payload": {}}`.

### –ü—Ä–∏–º–µ—Ä (JavaScript)

```javascript
const token = "eyJ...";
const roomId = 1;
const ws = new WebSocket(`ws://localhost:8000/api/rooms/${roomId}/chat?token=${token}`);

ws.onmessage = (e) => {
  const data = JSON.parse(e.data);
  if (data.type === "connected") {
    console.log("–ü–æ–¥–∫–ª—é—á–µ–Ω–æ:", data.payload.message);
  }
  if (data.type === "message") {
    const { id, text, sender, agentId } = data.payload;
    console.log(`${sender}: ${text}`);
    // –î–æ–±–∞–≤–∏—Ç—å –≤ UI
  }
};

ws.onopen = () => {
  setInterval(() => ws.send(JSON.stringify({ type: "ping" })), 25000);
};
```

---

## 7. –ì—Ä–∞—Ñ –æ—Ç–Ω–æ—à–µ–Ω–∏–π

### WebSocket –≥—Ä–∞—Ñ–∞

```
ws://localhost:8000/api/rooms/{roomId}/graph?token={JWT}
```

**–í—Ö–æ–¥—è—â–∏–µ:**

- `connected` ‚Äî –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
- `edge_update` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–±—Ä–∞ –º–µ–∂–¥—É –∞–≥–µ–Ω—Ç–∞–º–∏
- `pong` ‚Äî –æ—Ç–≤–µ—Ç –Ω–∞ ping
- `error` ‚Äî –æ—à–∏–±–∫–∞

**–ü—Ä–∏–º–µ—Ä `edge_update`:**

```json
{
  "type": "edge_update",
  "payload": {
    "roomId": "1",
    "from": "1",
    "to": "2",
    "sympathyLevel": 0.7
  }
}
```

### REST: –≥—Ä–∞—Ñ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è

```http
GET /api/rooms/{roomId}/relationship-model
GET /api/rooms/{roomId}/relationships
Authorization: Bearer <token>
```

---

## 8. –†–µ–∂–∏–º—ã –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏

| –†–µ–∂–∏–º | –ü–æ–≤–µ–¥–µ–Ω–∏–µ |
|-------|-----------|
| **single** | –ö–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ. –ü—Ä–∏ `POST /messages` ‚Äî –∫–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–≤–æ–π –æ—Ç–≤–µ—Ç. –ü—Ä–∏ `POST /agents/{id}/messages` ‚Äî —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç –∞–≥–µ–Ω—Ç. |
| **circular** | –ê–≥–µ–Ω—Ç—ã –ø–æ –∫—Ä—É–≥—É (–¥–æ 50 —Ä–∞—É–Ω–¥–æ–≤), —Ñ–æ–∫—É—Å –Ω–∞ –∑–∞–ø—Ä–æ—Å–µ. –í –∫–∞–∂–¥–æ–º —á–∞—Ç–µ —É—á–∞—Å—Ç–≤—É—é—Ç **–†–∞—Å—Å–∫–∞–∑—á–∏–∫** (üé≠) ‚Äî –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ü–µ–Ω—É; **–°—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä** (üìä) ‚Äî —Å–≤–æ–¥–∫–∞ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ä–∞—É–Ω–¥–∞; **–°–∏—Å—Ç–µ–º–∞** ‚Äî ¬´–†–∞—É–Ω–¥ X –∑–∞–≤–µ—Ä—à—ë–Ω¬ª. –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç SolutionSynthesizer. |
| **narrator** | –ü–µ—Ä–≤—ã–π –∞–≥–µ–Ω—Ç ‚Äî —Ä–∞—Å—Å–∫–∞–∑—á–∏–∫, –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–∂–∏. –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≤–∏–≤–∞–µ—Ç—Å—è –ø–æ —Å—é–∂–µ—Ç—É. |
| **full_context** | –û–±—Å—É–∂–¥–µ–Ω–∏–µ —Å —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–µ–π —Ä–∞—É–Ω–¥–æ–≤. |

### Pipeline (–ø—Ä–∏ orchestration_type ‚â† single)

–ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –ø—Ä–æ—Ö–æ–¥–∏—Ç —ç—Ç–∞–ø—ã:

1. RETRIEVE_MEMORY ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ ChromaDB  
2. PLAN ‚Äî –ø–ª–∞–Ω (–∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)  
3. DISCUSS ‚Äî –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤ (–≤ circular: –∞–≥–µ–Ω—Ç—ã + –†–∞—Å—Å–∫–∞–∑—á–∏–∫ + –°—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä)  
4. SYNTHESIZE ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (SolutionSynthesizer)  
5. STORE_MEMORY ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç—å  
6. FACT_EXTRACTION ‚Äî –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç—Ä–∏–ø–ª–µ—Ç–æ–≤  
7. UPDATE_GRAPH ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∞  

–°–æ–æ–±—â–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–æ–≤, –†–∞—Å—Å–∫–∞–∑—á–∏–∫–∞, –°—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä–∞ –∏ –°–∏—Å—Ç–µ–º—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –ø–æ WebSocket –ø–æ –º–µ—Ä–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è. –ü—Ä–æ–º–ø—Ç—ã –æ–±–æ–≥–∞—â–∞—é—Ç—Å—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∞–≥–µ–Ω—Ç–æ–≤.

---

## 9. –ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### JavaScript / TypeScript

```javascript
const API = "http://localhost:8000";
const WS = "ws://localhost:8000";

// 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
async function login(email, password) {
  const res = await fetch(`${API}/api/auth/login`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, password }),
  });
  const data = await res.json();
  if (!data.token) throw new Error("Login failed");
  return data.token;
}

// 2. –ö–æ–º–Ω–∞—Ç–∞
async function createRoom(token, name, orchestrationType = "circular") {
  const res = await fetch(`${API}/api/rooms`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`,
    },
    body: JSON.stringify({
      name,
      orchestration_type: orchestrationType,
      description: "",
    }),
  });
  return res.json();
}

// 3. –ê–≥–µ–Ω—Ç
async function addAgent(token, roomId, name, character) {
  const res = await fetch(`${API}/api/rooms/${roomId}/agents`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`,
    },
    body: JSON.stringify({ name, character }),
  });
  return res.json();
}

// 4. WebSocket —á–∞—Ç–∞
function connectChat(roomId, token, onMessage) {
  const ws = new WebSocket(`${WS}/api/rooms/${roomId}/chat?token=${token}`);
  ws.onmessage = (e) => {
    const data = JSON.parse(e.data);
    if (data.type === "message") onMessage(data.payload);
    if (data.type === "connected") console.log("Connected");
  };
  ws.onopen = () => {
    setInterval(() => ws.send(JSON.stringify({ type: "ping" })), 25000);
  };
  return ws;
}

// 5. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
async function sendMessage(token, roomId, text) {
  const res = await fetch(`${API}/api/rooms/${roomId}/messages`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`,
    },
    body: JSON.stringify({ text, sender: "user" }),
  });
  return res.json();
}

// –ü–æ–ª–Ω—ã–π flow
(async () => {
  const token = await login("user@example.com", "password123");
  const room = await createRoom(token, "–ú–æ—è –∫–æ–º–Ω–∞—Ç–∞", "circular");
  const roomId = room.id;

  await addAgent(token, roomId, "–ê–Ω–∞–ª–∏—Ç–∏–∫", "–õ—é–±–∏—Ç —Ü–∏—Ñ—Ä—ã –∏ —Ñ–∞–∫—Ç—ã.");
  await addAgent(token, roomId, "–ö—Ä–µ–∞—Ç–∏–≤—â–∏–∫", "–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–¥–µ–∏.");

  const ws = connectChat(roomId, token, (msg) => {
    console.log(`${msg.sender}: ${msg.text}`);
  });

  // –ñ–¥—ë–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, –∑–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
  await new Promise((r) => setTimeout(r, 1000));
  await sendMessage(token, roomId, "–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ –µ–¥—ã.");

  // –û—Ç–≤–µ—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤ –ø—Ä–∏–¥—É—Ç –ø–æ ws
})();
```

### React (–∫—Ä–∞—Ç–∫–æ)

```tsx
// –•—É–∫ WebSocket
useEffect(() => {
  if (!roomId || !token) return;
  const ws = new WebSocket(`ws://localhost:8000/api/rooms/${roomId}/chat?token=${token}`);
  ws.onmessage = (e) => {
    const { type, payload } = JSON.parse(e.data);
    if (type === "message") setMessages((m) => [...m, payload]);
  };
  return () => ws.close();
}, [roomId, token]);
```

---

## 10. –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ê–≥–µ–Ω—Ç—ã –Ω–µ –æ—Ç–≤–µ—á–∞—é—Ç

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ WebSocket **–ø–æ–¥–∫–ª—é—á—ë–Ω –¥–æ** –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –∫–æ–º–Ω–∞—Ç–µ –µ—Å—Ç—å –∞–≥–µ–Ω—Ç—ã
- –î–ª—è orchestration: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ `YANDEX_CLOUD_FOLDER` –∏ `YANDEX_CLOUD_API_KEY`

### 401 Unauthorized

- –¢–æ–∫–µ–Ω –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –∏–ª–∏ –∏—Å—Ç—ë–∫
- –î–æ–±–∞–≤—å—Ç–µ `Authorization: Bearer <token>`

### 403 Forbidden (WebSocket)

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–º–Ω–∞—Ç–µ (–∫–æ–º–Ω–∞—Ç–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –¥—Ä—É–≥–æ–º—É user_id)

### –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `orchestration_type` –∫–æ–º–Ω–∞—Ç—ã (–Ω–µ `single`)
- –í –ª–æ–≥–∞—Ö: `create_pipeline_components YandexAgentClient fail` ‚Äî –Ω–µ—Ç Yandex –∫–ª—é—á–µ–π

### –°–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π

- Pipeline –≤—ã–ø–æ–ª–Ω—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç—Ç–∞–ø–æ–≤ (memory, discuss, synthesize). –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.
- –í —Ä–µ–∂–∏–º–µ circular ‚Äî –¥–æ 50 —Ä–∞—É–Ω–¥–æ–≤ –æ–±—Å—É–∂–¥–µ–Ω–∏—è (–∞–≥–µ–Ω—Ç—ã + –†–∞—Å—Å–∫–∞–∑—á–∏–∫ + –°—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä) + —Å–∏–Ω—Ç–µ–∑.

### CORS

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é FastAPI —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —Å –ª—é–±–æ–≥–æ origin. –î–ª—è production –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ CORS –≤ `app/main.py`.

---

## –ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤

| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | Auth |
|-------|------|------|
| POST | /api/auth/register | ‚Äî |
| POST | /api/auth/login | ‚Äî |
| GET | /api/auth/me | Bearer |
| GET | /api/rooms | Bearer |
| POST | /api/rooms | Bearer |
| GET | /api/rooms/{id} | Bearer |
| PATCH | /api/rooms/{id} | Bearer |
| DELETE | /api/rooms/{id} | Bearer |
| GET | /api/rooms/{id}/agents | Bearer |
| POST | /api/rooms/{id}/agents | Bearer |
| POST | /api/rooms/{id}/messages | Bearer |
| GET | /api/rooms/{id}/messages | Bearer |
| GET | /api/rooms/{id}/feed | Bearer |
| POST | /api/rooms/{id}/agents/{aid}/messages | Bearer |
| GET | /api/rooms/{id}/relationship-model | Bearer |
| GET | /api/default-agents | ‚Äî |
| WS | /api/rooms/{id}/chat?token= | JWT –≤ query |
| WS | /api/rooms/{id}/graph?token= | JWT –≤ query |

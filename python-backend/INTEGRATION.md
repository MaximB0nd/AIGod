# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã + –º–æ–¥—É–ª–∏ YandexGPT/–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏

**–î–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞:**
- **API:** `API_DOCS.md` ‚Äî –ø–æ–ª–Ω—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ REST
- **WebSocket:** `WEBSOCKET_CLIENT.md`
- **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:** `CONNECTION.md` ‚Äî –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

---

## –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (`.env`)

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------------|----------|--------------|
| `YANDEX_CLOUD_FOLDER` | folder_id –≤ Yandex Cloud | ‚Äî |
| `YANDEX_CLOUD_API_KEY` | API key (–º–æ–∂–Ω–æ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `Api-Key `) | ‚Äî |
| `API_MESSAGE_LIMIT_PER_DAY` | –õ–∏–º–∏—Ç –≤—ã–∑–æ–≤–æ–≤ Yandex API –≤ –¥–µ–Ω—å (0 = –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π) | `0` |
| `SQLITE_DB_PATH` | –ü—É—Ç—å –∫ SQLite –ë–î | `aigod.db` |
| `SECRET_KEY` | JWT —Å–µ–∫—Ä–µ—Ç | (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π) |
| `LOG_LEVEL` | –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–æ–≤: `DEBUG`, `INFO`, `WARNING`, `ERROR` | `INFO` |

**`LOG_LEVEL=DEBUG`** ‚Äî –ø–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ WebSocket (connect/disconnect/broadcast), –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏ (enqueue, tick, strategy), LLM-–∑–∞–ø—Ä–æ—Å–æ–≤.

### –ó–∞–ø—É—Å–∫

```bash
pip install -r requirements.txt
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

---

## –õ–æ–≥–∏–∫–∞ –∞–≥–µ–Ω—Ç–æ–≤

### –¢–∞–±–ª–∏—Ü–∞ `agents` –∏ `default_agents`
- **agents** ‚Äî —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∞–≥–µ–Ω—Ç—ã. –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø—É—Å—Ç–∞.
- **default_agents** ‚Äî —à–∞–±–ª–æ–Ω—ã (–ö–æ–ø–∞—Ç—ã—á, –ì–µ—Ä–º–∏–æ–Ω–∞, –ù–∞—Ä—Ä–∞—Ç–æ—Ä, –°—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä –∏ —Ç.–¥.). –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å—Ç–∞—Ä—Ç–µ –∏–∑ `app/data/default_agents_data.py`. –í —Ä–µ–∂–∏–º–µ `circular` –†–∞—Å—Å–∫–∞–∑—á–∏–∫ –∏ –°—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

### –°–æ–∑–¥–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞ –ø–æ —à–∞–±–ª–æ–Ω—É
1. `GET /api/default-agents` ‚Äî —Å–ø–∏—Å–æ–∫ —à–∞–±–ª–æ–Ω–æ–≤
2. `GET /api/default-agents/{id}` ‚Äî –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–æ—Ä–º—ã (name, character, avatar)
3. `POST /api/rooms/{roomId}/agents` —Å `{name, character, avatar}` ‚Äî —Å–æ–∑–¥–∞—ë—Ç –∞–≥–µ–Ω—Ç–∞ –≤ –∫–æ–º–Ω–∞—Ç–µ

---

## LLM –∏ —Å–æ–æ–±—â–µ–Ω–∏—è

### POST `/api/rooms/{roomId}/messages` ‚Äî –æ–±—â–∏–π —á–∞—Ç –∫–æ–º–Ω–∞—Ç—ã (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
- –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–º–Ω–∞—Ç—É (–≤—Å–µ –∞–≥–µ–Ω—Ç—ã –≤–∏–¥—è—Ç)
- –í —Ä–µ–∂–∏–º–µ `single`: —Ç—Ä–∏–≥–≥–µ—Ä –æ—Ç–≤–µ—Ç–∞ –æ—Ç **–∫–∞–∂–¥–æ–≥–æ** –∞–≥–µ–Ω—Ç–∞ (–≤—Å–µ –æ—Ç–≤–µ—á–∞—é—Ç)
- –í —Ä–µ–∂–∏–º–µ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏ (`circular`, `narrator`, `full_context`): —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–¥—ë—Ç –≤ –æ—á–µ—Ä–µ–¥—å –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏
- –û—Ç–≤–µ—Ç—ã —Ä–∞—Å—Å—ã–ª–∞—é—Ç—Å—è –≤ WebSocket `/api/rooms/{roomId}/chat`

### POST `/api/rooms/{roomId}/agents/{agentId}/messages` ‚Äî –ª–∏—á–Ω–∞—è –ø–µ—Ä–µ–ø–∏—Å–∫–∞
- –°–æ–æ–±—â–µ–Ω–∏–µ **–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É** –∞–≥–µ–Ω—Ç—É (—á–∞—Ç 1-–Ω–∞-1)
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è **YandexGPT** —á–µ—Ä–µ–∑ `YandexAgentClient`
- –û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ `agentResponse`
- –°–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ—Ç–≤–µ—Ç —Ä–∞—Å—Å—ã–ª–∞—é—Ç—Å—è –≤ WebSocket
- **WebSocket –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–¥–∫–ª—é—á—ë–Ω –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏** ‚Äî –∏–Ω–∞—á–µ broadcast –Ω–µ –¥–æ—Å—Ç–∞–≤–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É

---

## –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è

### Pipeline –æ–±–º–µ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

```
User ‚Üí POST /rooms/{roomId}/messages
     ‚Üí –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ (agent_id=None)
     ‚Üí Broadcast –≤ WebSocket
     ‚Üí enqueue_user_message(room_id, text, sender)
     ‚Üí UserMessageEvent –≤ –æ—á–µ—Ä–µ–¥—å –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏
     ‚Üí strategy.handle_user_message
     ‚Üí tick loop ‚Üí –∞–≥–µ–Ω—Ç—ã –æ—Ç–≤–µ—á–∞—é—Ç
     ‚Üí –æ—Ç–≤–µ—Ç—ã –≤ –ë–î + broadcast
```

### –¢–∏–ø –∫–æ–º–Ω–∞—Ç—ã `orchestration_type`
- `single` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±—â–∞–µ—Ç—Å—è —Å –∞–≥–µ–Ω—Ç–∞–º–∏ (–≤—Å–µ –æ—Ç–≤–µ—á–∞—é—Ç –Ω–∞–ø—Ä—è–º—É—é)
- `circular` ‚Äî –∞–≥–µ–Ω—Ç—ã –æ–±—â–∞—é—Ç—Å—è –ø–æ –∫—Ä—É–≥—É. –í –∫–∞–∂–¥–æ–º —á–∞—Ç–µ —É—á–∞—Å—Ç–≤—É—é—Ç –†–∞—Å—Å–∫–∞–∑—á–∏–∫ (üé≠) –∏ –°—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä (üìä). –î–æ 50 —Ä–∞—É–Ω–¥–æ–≤.
- `narrator` ‚Äî –∞–≥–µ–Ω—Ç-—Ä–∞—Å—Å–∫–∞–∑—á–∏–∫
- `full_context` ‚Äî –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –≤—Å–µ—Ö

**–°–æ–∑–¥–∞–Ω–∏–µ:** `POST /api/rooms` —Å `{"name": "...", "orchestration_type": "circular"}`  
**PATCH /api/rooms/{id}** ‚Äî —Ç–æ–ª—å–∫–æ `description` –∏ `speed` (orchestration_type –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è).

### –†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- `POST /api/rooms/{roomId}/orchestration/start` ‚Äî –∑–∞–ø—É—Å–∫ `OrchestrationClient`
- `POST /api/rooms/{roomId}/orchestration/stop` ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∫–∞

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–∞—Ç–∞ —Å –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–µ–π
- –ü—Ä–∏ –ø–µ—Ä–≤–æ–º `POST /messages` –≤ –∫–æ–º–Ω–∞—Ç–µ —Å –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–µ–π —Å–æ–∑–¥–∞—ë—Ç—Å—è `OrchestrationClient`
- –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è **–∏—Å—Ç–æ—Ä–∏—è –∫–æ–º–Ω–∞—Ç—ã –∏–∑ –ë–î** –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏
- `enqueue_user_message(room_id, text, sender)` —Å—Ç–∞–≤–∏—Ç `UserMessageEvent` –≤ –æ—á–µ—Ä–µ–¥—å
- –°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ, tick loop –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤

---

## –°–µ—Ä–≤–∏—Å—ã (relationship, memory, emotions)

### –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã
- `GET /api/rooms/{id}/relationship-model` ‚Äî –≥—Ä–∞—Ñ –æ—Ç–Ω–æ—à–µ–Ω–∏–π
- `GET /api/rooms/{id}/emotional-state` ‚Äî —ç–º–æ—Ü–∏–∏ –∞–≥–µ–Ω—Ç–æ–≤
- `GET /api/rooms/{id}/context-memory` ‚Äî —Å–≤–æ–¥–∫–∞ –¥–∏–∞–ª–æ–≥–∞

### –û–±–æ–≥–∞—â–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤
- LLM –∏ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—É—á–∞—é—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ—Ç–Ω–æ—à–µ–Ω–∏–π –∏–∑ `relationship_model`

---

## –¢–µ—Å—Ç—ã

```bash
SQLITE_DB_PATH=:memory: pytest tests/ -v
```

| –§–∞–π–ª | –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç |
|------|---------------|
| `tests/test_llm_service.py` | AgentPromptAdapter, fallback –±–µ–∑ –∫–ª—é—á–µ–π |
| `tests/test_message_endpoint_integration.py` | POST messages ‚Üí LLM ‚Üí broadcast |
| `tests/test_orchestration.py` | OrchestrationClient, CircularStrategy |
